name: Test Deployment

on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  test-deployment:
    name: Test Deploy and Verify
    runs-on: ubuntu-latest
    environment:
      name: test-deployment
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          targets: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
            chimera-web -> target
          cache-on-failure: true
          shared-key: "wasm-build"

      - name: Cache Trunk binary
        id: cache-trunk
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/trunk
          key: ${{ runner.os }}-trunk-${{ hashFiles('.cargo/config.toml') }}

      - name: Install trunk
        if: steps.cache-trunk.outputs.cache-hit != 'true'
        run: cargo install trunk --locked

      - name: Cache wasm-bindgen
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/wasm-bindgen
            ~/.cargo/bin/wasm-opt
          key: ${{ runner.os }}-wasm-tools-${{ hashFiles('rust-toolchain.toml') }}

      - name: Build web dashboard
        working-directory: ./chimera-web
        run: trunk build --release --public-url /chimera

      - name: Verify build output exists
        run: |
          if [ ! -d "chimera-web/dist" ]; then
            echo "Error: dist directory not found"
            exit 1
          fi
          if [ ! -f "chimera-web/dist/index.html" ]; then
            echo "Error: index.html not found"
            exit 1
          fi
          echo "Build artifacts verified successfully"

      - name: Check WASM files exist
        run: |
          if ! ls chimera-web/dist/*.wasm 1> /dev/null 2>&1; then
            echo "Error: No WASM files found in dist"
            exit 1
          fi
          echo "WASM files found:"
          ls -lh chimera-web/dist/*.wasm

      - name: Verify HTML structure
        run: |
          if ! grep -q "chimera-web" chimera-web/dist/index.html; then
            echo "Warning: HTML might not contain expected content"
          fi
          echo "HTML structure check passed"

      - name: Create deployment summary
        run: |
          echo "## Test Deployment Successful âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The web dashboard has been built and verified:" >> $GITHUB_STEP_SUMMARY
          echo "- Build artifacts created successfully" >> $GITHUB_STEP_SUMMARY
          echo "- WASM modules compiled" >> $GITHUB_STEP_SUMMARY
          echo "- HTML structure validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Output Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh chimera-web/dist/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload test deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-deployment-${{ github.event.pull_request.number }}
          path: chimera-web/dist
          retention-days: 7

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const distFiles = fs.readdirSync('chimera-web/dist');
            const wasmFiles = distFiles.filter(f => f.endsWith('.wasm'));
            
            const comment = `## ðŸš€ Test Deployment Successful
            
            The web dashboard has been successfully built and verified for this PR.
            
            ### âœ… Verification Checks Passed:
            - Build artifacts created
            - WASM modules compiled (${wasmFiles.length} files)
            - HTML structure validated
            
            ### ðŸ“¦ Artifacts:
            - Artifact name: \`test-deployment-${{ github.event.pull_request.number }}\`
            - Retention: 7 days
            
            The deployment is ready to be merged to main.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
